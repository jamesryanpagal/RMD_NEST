name: Deploy to EC2

on:
    push:
        branches:
            - master

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v3

            - name: Deploy via SSH to EC2
              uses: appleboy/ssh-action@v1.0.0
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USER }}
                  key: ${{ secrets.EC2_SSH_KEY }}
                  script: |
                      set -e

                      echo "→ Pulling latest code from Git..." 
                      cd /home/ubuntu/RMD_NEST
                      git pull

                      echo "→ Stopping existing containers..."
                      docker compose down --remove-orphans || true

                      echo "→ Building and starting new containers..."
                      if docker compose up --build -d; then
                        echo "✅ Deployment successful!"

                        echo "→ Cleaning unused Docker images..."
                        docker image prune -f
                      else
                        echo "❌ Deployment failed. Rolling back..."

                        echo "→ Resetting to previous stable commit..."
                        git reset --hard HEAD~1

                        echo "→ Rebuilding using previous version..."
                        docker compose up --build -d
                      fi
