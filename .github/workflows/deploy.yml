name: Deploy to EC2

on:
    push:
        branches:
            - master

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v3

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ap-southeast-1

            - name: Deploy using SSM with rollback
              run: |
                  # Send remote deployment commands to EC2 via SSM
                  COMMAND_ID=$(aws ssm send-command \
                    --instance-ids ${{ secrets.EC2_INSTANCE_ID }} \
                    --document-name "AWS-RunShellScript" \
                    --comment "Deploy NestJS App" \
                    --parameters commands='[
                      "set -e",
                      "echo ✅ Starting deployment...",
                      "cd /home/ubuntu/RMD_NEST",

                      "echo → Stashing local changes (just in case)...",
                      "git reset --hard",

                      "echo → Pulling latest version from Git...",
                      "git pull origin master",

                      "echo → Stopping containers...",
                      "docker compose down --remove-orphans || true",

                      "echo → Building and starting containers...",
                      "if docker compose up -d --build; then",
                      "  echo ✅ Deployment success!",
                      "else",
                      "  echo ❌ Deployment failed! Rolling back…",

                      "  echo → Resetting to previous commit...",
                      "  git reset --hard HEAD~1",

                      "  echo → Rebuilding old version...",
                      "  docker compose up -d --build || true",

                      "  exit 1",
                      "fi",

                      "echo → Cleaning unused images...",
                      "docker image prune -f",

                      "echo ✅ Deployment finished."
                    ]' \
                    --query "Command.CommandId" \
                    --output text)

                  echo "SSM command sent with ID: $COMMAND_ID"
